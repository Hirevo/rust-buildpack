#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

### Configure environment
set -o errexit    # always exit on error
set -o pipefail   # don t ignore exit codes when piping output

unset GIT_DIR     # Avoid GIT_DIR leak from previous build steps

RESET=$'\033[0m'
BOLD=$'\033[1m'
RED=$'\033[38;2;255;85;85m'
GREEN=$'\033[38;2;38;252;166m'
BLUE=$'\033[38;2;0;133;255m'

handle_error() {
    echo
    echo $BOLD$RED"Build failed !"$RESET
    echo
}
trap 'handle_error' ERR

### Constants

DEFAULT_CACHE="node_modules bower_components"
BPLOG_PREFIX="buildpack.nodejs"

### Configure directories
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

### Install Rust toolchain
echo
echo $BOLD$BLUE"Installing Rust toolchain..."$RESET
echo
curl https://sh.rustup.rs -sSf | sh -s -- -y
source $HOME/.cargo/env

### Compiling application
echo
echo $BOLD$BLUE"Compiling application..."$RESET
echo
cargo build --release

### Cleaning artifacts
echo
echo $BOLD$BLUE"Cleaning artifacts..."$RESET
echo
BINARY=$(find $BUILD_DIR/target/release -maxdepth 1 -type f -executable)
cp $BINARY $BUILD_DIR
cargo clean

echo
echo $BOLD$GREEN"Build succeeded !"$RESET
echo
